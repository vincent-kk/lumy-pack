#!/usr/bin/env node
import*as n from"node:fs";import*as f from"node:path";var D=["components","utils","types","hooks","helpers","lib","styles","assets","constants"],u=[...D,"test","tests","spec","specs","fixtures","e2e"];function y(t){let r=t.startsWith("__")&&t.endsWith("__")&&t.length>4,e=t.startsWith(".");return r||e}function m(t){return t.hasClaudeMd||t.hasSpecMd?"fractal":y(t.dirName)||u.includes(t.dirName)?"organ":(t.hasIndex??!1)&&!u.includes(t.dirName)&&!y(t.dirName)?"fractal":!t.hasFractalChildren&&t.isLeafDirectory?"organ":t.hasSideEffects??!0?"fractal":"pure-function"}function I(t,r){let e=t.replace(/\\/g,"/").split("/").filter(i=>i.length>0),a=e[e.length-1]??"";if(a==="CLAUDE.md"||a==="SPEC.md")return"fractal";let s=r;for(let i of e.slice(0,-1)){s=f.join(s,i);try{if(!n.existsSync(s)){if(u.includes(i))return"organ";continue}let c=n.readdirSync(s,{withFileTypes:!0}),l=c.some(o=>o.isFile()&&o.name==="CLAUDE.md"),d=c.some(o=>o.isFile()&&o.name==="SPEC.md"),h=c.filter(o=>o.isDirectory()),E=h.length===0,_=h.some(o=>{try{let N=f.join(s,o.name);return n.readdirSync(N,{withFileTypes:!0}).some(g=>g.isFile()&&(g.name==="CLAUDE.md"||g.name==="SPEC.md"))}catch{return!1}});if(m({dirName:i,hasClaudeMd:l,hasSpecMd:d,hasFractalChildren:_,isLeafDirectory:E})==="organ")return"organ"}catch{continue}}return"unknown"}function k(t,r){try{let e=f.join(t,".filid"),a=f.join(e,"change-log.jsonl");n.existsSync(e)||n.mkdirSync(e,{recursive:!0}),n.appendFileSync(a,JSON.stringify(r)+`
`,"utf-8")}catch{}}function C(t,r){if(t.tool_name!=="Write"&&t.tool_name!=="Edit")return{continue:!0};let e=t.tool_input.file_path??t.tool_input.path??"";if(!e)return{continue:!0};let a=t.cwd,s=t.tool_name,i=s==="Write"?"created":"modified";r.enqueue({filePath:e,changeType:i});let c=I(e,a),l=new Date().toISOString(),d={timestamp:l,action:s,path:e,category:c,sessionId:t.session_id};return k(a,d),process.env.FILID_DEBUG==="1"?{continue:!0,hookSpecificOutput:{additionalContext:`[filid:change] ${l} ${s} ${e} ${c}`}}:{continue:!0}}var O={enqueue:t=>{}},S=[];for await(let t of process.stdin)S.push(t);var b=Buffer.concat(S).toString("utf-8"),p;try{let t=JSON.parse(b);p=C(t,O)}catch{p={continue:!0}}process.stdout.write(JSON.stringify(p));
