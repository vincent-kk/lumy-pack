#!/usr/bin/env node
import{readFileSync as y}from"node:fs";var u={alwaysDo:/^###?\s*(always\s*do)/im,askFirst:/^###?\s*(ask\s*first)/im,neverDo:/^###?\s*(never\s*do)/im};function h(e){if(e.length===0)return 0;let t=e.endsWith(`
`)?e.slice(0,-1):e;return t.length===0?0:t.split(`
`).length}function p(e){let t=[],n=h(e);n>100&&t.push({rule:"line-limit",message:`CLAUDE.md exceeds 100-line limit (${n} lines). Compress or deduplicate content.`,severity:"error"});let s=u.alwaysDo.test(e),i=u.askFirst.test(e),r=u.neverDo.test(e);if(!s||!i||!r){let o=[];s||o.push("Always do"),i||o.push("Ask first"),r||o.push("Never do"),t.push({rule:"missing-boundaries",message:`CLAUDE.md is missing 3-tier boundary sections: ${o.join(", ")}`,severity:"warning"})}return{valid:t.every(o=>o.severity!=="error"),violations:t}}function v(e,t){if(e.length===0)return!1;let n=e.trimEnd().split(`
`),s=t.trimEnd().split(`
`);if(s.length<=n.length)return!1;for(let i=0;i<n.length;i++)if(n[i]!==s[i])return!1;return!0}function f(e,t){let n=[];return t!==void 0&&v(t,e)&&n.push({rule:"append-only",message:"SPEC.md must not be append-only. Restructure and compress content instead of simply appending.",severity:"error"}),{valid:n.every(s=>s.severity!=="error"),violations:n}}function d(e){return e.endsWith("/CLAUDE.md")||e==="CLAUDE.md"}function a(e){return e.endsWith("/SPEC.md")||e==="SPEC.md"}function m(e,t){let n=e.tool_input.file_path??e.tool_input.path??"";if(e.tool_name==="Edit"&&d(n)){let r=(e.tool_input.new_string??"").split(`
`).length;return r>20?{continue:!0,hookSpecificOutput:{additionalContext:`Note: Editing CLAUDE.md via Edit tool with ${r} new lines \u2014 line limit (100) cannot be enforced on partial edits. Verify the final line count does not exceed 100 lines after editing.`}}:{continue:!0}}let s=e.tool_input.content;if(e.tool_name!=="Write"||!s)return{continue:!0};if(d(n)){let i=p(s);if(!i.valid)return{continue:!1,hookSpecificOutput:{additionalContext:`BLOCKED: ${i.violations.filter(l=>l.severity==="error").map(l=>l.message).join("; ")}`}};let r=i.violations.filter(o=>o.severity==="warning");return r.length>0?{continue:!0,hookSpecificOutput:{additionalContext:r.map(o=>o.message).join("; ")}}:{continue:!0}}if(a(n)&&t!==void 0){let i=f(s,t);if(!i.valid)return{continue:!1,hookSpecificOutput:{additionalContext:`BLOCKED: ${i.violations.filter(o=>o.severity==="error").map(o=>o.message).join("; ")}`}}}return{continue:!0}}var g=[];for await(let e of process.stdin)g.push(e);var D=Buffer.concat(g).toString("utf-8"),c;try{let e=JSON.parse(D),t=e.tool_input.file_path??e.tool_input.path??"",n;if(e.tool_name==="Write"&&a(t))try{n=y(t,"utf-8")}catch{}c=m(e,n)}catch{c={continue:!0}}process.stdout.write(JSON.stringify(c));
