#!/usr/bin/env node
import{existsSync as O}from"node:fs";import{join as S}from"node:path";import{createHash as d}from"node:crypto";import{existsSync as u,mkdirSync as x,readFileSync as y,readdirSync as v,statSync as T,unlinkSync as U,writeFileSync as m}from"node:fs";import{homedir as L}from"node:os";import{join as c}from"node:path";function P(t){return d("sha256").update(t).digest("hex").slice(0,12)}function l(t){let e=process.env.CLAUDE_CONFIG_DIR??c(L(),".claude");return c(e,"plugins","filid",P(t))}function R(t){let e=l(t),n=c(e,"timestamp"),r=c(e,"cached-context.txt");try{if(!u(n)||!u(r))return null;let a=y(n,"utf-8").trim(),s=y(r,"utf-8"),i=d("sha256").update(s).digest("hex").slice(0,8);return a!==i?null:s}catch{return null}}function C(t,e){let n=l(t),r=c(n,"timestamp"),a=c(n,"cached-context.txt");try{u(n)||x(n,{recursive:!0}),m(a,e,"utf-8");let s=d("sha256").update(e).digest("hex").slice(0,8);m(r,s,"utf-8")}catch{}}function N(t){return d("sha256").update(t).digest("hex").slice(0,12)}function I(t,e){let n=c(l(e),`session-${N(t)}`);try{return!u(n)}catch{return!0}}function k(t){try{let e=l(t),r=v(e).filter(i=>i.startsWith("session-"));if(r.length<=10)return;let a=Date.now(),s=24*60*60*1e3;for(let i of r){let p=c(e,i);try{a-T(p).mtimeMs>s&&U(p)}catch{}}}catch{}}function f(t,e){let n=l(e),r=c(n,`session-${N(t)}`);try{u(n)||x(n,{recursive:!0}),m(r,"","utf-8"),k(e)}catch{}}var o={NAMING_CONVENTION:"naming-convention",ORGAN_NO_CLAUDEMD:"organ-no-claudemd",INDEX_BARREL_PATTERN:"index-barrel-pattern",MODULE_ENTRY_POINT:"module-entry-point",MAX_DEPTH:"max-depth",CIRCULAR_DEPENDENCY:"circular-dependency",PURE_FUNCTION_ISOLATION:"pure-function-isolation"};var E={include:["**"],exclude:["**/node_modules/**","**/.git/**","**/dist/**","**/build/**","**/coverage/**","**/docs/**","**/scripts/**","**/.filid/**","**/.claude/**","**/.omc/**","**/.metadata/**","**/next/**","**/libs/**"],maxDepth:10,followSymlinks:!1};var F=/^[a-z][a-z0-9]*(-[a-z0-9]+)*$/,w=/^[a-z][a-zA-Z0-9]*$/;function M(t){return F.test(t)||w.test(t)}function _(){return[{id:o.NAMING_CONVENTION,name:"Naming Convention",description:"\uB514\uB809\uD1A0\uB9AC/\uD30C\uC77C\uBA85\uC774 kebab-case \uB610\uB294 camelCase\uB97C \uB530\uB77C\uC57C \uD55C\uB2E4.",category:"naming",severity:"warning",enabled:!0,check(t){let{node:e}=t;return M(e.name)?[]:[{ruleId:o.NAMING_CONVENTION,severity:"warning",message:`\uB514\uB809\uD1A0\uB9AC\uBA85 "${e.name}"\uC774 kebab-case \uB610\uB294 camelCase \uADDC\uCE59\uC744 \uB530\uB974\uC9C0 \uC54A\uC2B5\uB2C8\uB2E4.`,path:e.path,suggestion:`"${e.name}"\uC744 kebab-case(\uC608: my-module) \uB610\uB294 camelCase(\uC608: myModule)\uB85C \uBCC0\uACBD\uD558\uC138\uC694.`}]}},{id:o.ORGAN_NO_CLAUDEMD,name:"Organ No CLAUDE.md",description:"organ \uB178\uB4DC\uC5D0 CLAUDE.md\uAC00 \uC874\uC7AC\uD558\uBA74 \uC548 \uB41C\uB2E4.",category:"structure",severity:"error",enabled:!0,check(t){let{node:e}=t;return e.type==="organ"&&e.hasClaudeMd?[{ruleId:o.ORGAN_NO_CLAUDEMD,severity:"error",message:`organ \uB514\uB809\uD1A0\uB9AC "${e.name}"\uC5D0 CLAUDE.md\uAC00 \uC874\uC7AC\uD569\uB2C8\uB2E4. organ\uC740 \uB3C5\uB9BD \uBB38\uC11C\uD654\uAC00 \uAE08\uC9C0\uB429\uB2C8\uB2E4.`,path:e.path,suggestion:"CLAUDE.md\uB97C \uC81C\uAC70\uD558\uAC70\uB098 \uD574\uB2F9 \uB514\uB809\uD1A0\uB9AC\uB97C fractal\uB85C \uC7AC\uBD84\uB958\uD558\uC138\uC694."}]:[]}},{id:o.INDEX_BARREL_PATTERN,name:"Index Barrel Pattern",description:"fractal \uB178\uB4DC\uC758 index.ts\uB294 \uC21C\uC218 barrel(re-export\uB9CC) \uD328\uD134\uC744 \uB530\uB77C\uC57C \uD55C\uB2E4.",category:"index",severity:"warning",enabled:!0,check(t){let{node:e}=t;if(e.type!=="fractal"&&e.type!=="hybrid")return[];if(!e.hasIndex)return[];let n=e.metadata.barrelPattern;return n&&!n.isPureBarrel&&n.declarationCount>0?[{ruleId:o.INDEX_BARREL_PATTERN,severity:"warning",message:`"${e.name}/index.ts"\uC5D0 ${n.declarationCount}\uAC1C\uC758 \uC9C1\uC811 \uC120\uC5B8\uC774 \uC788\uC2B5\uB2C8\uB2E4. \uC21C\uC218 barrel \uD328\uD134\uC744 \uB530\uB974\uC9C0 \uC54A\uC2B5\uB2C8\uB2E4.`,path:e.path,suggestion:"\uC9C1\uC811 \uC120\uC5B8\uC744 \uBCC4\uB3C4 \uD30C\uC77C\uB85C \uBD84\uB9AC\uD558\uACE0 index.ts\uC5D0\uC11C re-export\uD558\uC138\uC694."}]:[]}},{id:o.MODULE_ENTRY_POINT,name:"Module Entry Point",description:"\uBAA8\uB4E0 fractal \uB178\uB4DC\uC5D0 index.ts \uB610\uB294 main.ts\uAC00 \uC874\uC7AC\uD574\uC57C \uD55C\uB2E4.",category:"module",severity:"warning",enabled:!0,check(t){let{node:e}=t;return e.type!=="fractal"&&e.type!=="hybrid"?[]:!e.hasIndex&&!e.hasMain?[{ruleId:o.MODULE_ENTRY_POINT,severity:"warning",message:`fractal \uBAA8\uB4C8 "${e.name}"\uC5D0 \uC9C4\uC785\uC810(index.ts \uB610\uB294 main.ts)\uC774 \uC5C6\uC2B5\uB2C8\uB2E4.`,path:e.path,suggestion:"index.ts \uB610\uB294 main.ts\uB97C \uC0DD\uC131\uD558\uC5EC \uBAA8\uB4C8\uC758 \uACF5\uAC1C API\uB97C \uC815\uC758\uD558\uC138\uC694."}]:[]}},{id:o.MAX_DEPTH,name:"Max Depth",description:"\uD504\uB799\uD0C8 \uD2B8\uB9AC\uC758 \uAE4A\uC774\uAC00 \uCD5C\uB300 \uD5C8\uC6A9 \uAE4A\uC774\uB97C \uCD08\uACFC\uD558\uBA74 \uC548 \uB41C\uB2E4.",category:"structure",severity:"error",enabled:!0,check(t){let{node:e,scanOptions:n}=t,r=n?.maxDepth??E.maxDepth;return e.depth>r?[{ruleId:o.MAX_DEPTH,severity:"error",message:`"${e.name}"\uC758 \uAE4A\uC774(${e.depth})\uAC00 \uCD5C\uB300 \uD5C8\uC6A9 \uAE4A\uC774(${r})\uB97C \uCD08\uACFC\uD569\uB2C8\uB2E4.`,path:e.path,suggestion:"\uB514\uB809\uD1A0\uB9AC \uAD6C\uC870\uB97C \uD3C9\uD0C4\uD654\uD558\uAC70\uB098 \uAD00\uB828 \uBAA8\uB4C8\uC744 \uBCD1\uD569\uD558\uC138\uC694."}]:[]}},{id:o.CIRCULAR_DEPENDENCY,name:"Circular Dependency",description:"\uBAA8\uB4C8 \uAC04 \uC21C\uD658 \uC758\uC874\uC774 \uC5C6\uC5B4\uC57C \uD55C\uB2E4.",category:"dependency",severity:"error",enabled:!0,check(t){return[]}},{id:o.PURE_FUNCTION_ISOLATION,name:"Pure Function Isolation",description:"pure-function \uB178\uB4DC\uB294 \uC0C1\uC704 fractal \uBAA8\uB4C8\uC744 import\uD558\uBA74 \uC548 \uB41C\uB2E4.",category:"dependency",severity:"error",enabled:!0,check(t){let{node:e,tree:n}=t;if(e.type!=="pure-function")return[];let r=e.metadata.dependencies;if(!r||r.length===0)return[];let a=[];for(let s of r){let i=n.nodes.get(s);i&&(i.type==="fractal"||i.type==="hybrid")&&a.push({ruleId:o.PURE_FUNCTION_ISOLATION,severity:"error",message:`pure-function \uB178\uB4DC "${e.name}"\uC774 fractal \uBAA8\uB4C8 "${i.name}"\uC744 \uC758\uC874\uD569\uB2C8\uB2E4.`,path:e.path,suggestion:`"${i.name}"\uC758 \uD558\uC704 organ\uC73C\uB85C \uC774\uB3D9\uD558\uAC70\uB098 \uC758\uC874\uC744 \uC81C\uAC70\uD558\uC138\uC694.`})}return a}}]}function D(t){return t.filter(e=>e.enabled)}var $=["- fractal: independent module with CLAUDE.md or SPEC.md","- organ: leaf directory with no fractal children","- pure-function: collection of pure functions with no side effects","- hybrid: transitional node with both fractal and organ characteristics"].join(`
`);function V(t){return O(S(t,".filid"))||O(S(t,"CLAUDE.md"))}function j(t){return[`[FCA-AI] Active in: ${t}`,"Rules:","- CLAUDE.md: max 100 lines, must include 3-tier boundary sections","- SPEC.md: no append-only growth, must restructure on updates","- Organ directories (auto-classified by structure analysis) must NOT have CLAUDE.md","- Test files: max 15 cases per spec.ts (3 basic + 12 complex)","- LCOM4 >= 2 \u2192 split module, CC > 15 \u2192 compress/abstract"].join(`
`)}async function b(t){let{cwd:e,session_id:n}=t;if(!V(e))return{continue:!0};if(!I(n,e))return{continue:!0};let r=R(e);if(r)return f(n,e),{continue:!0,hookSpecificOutput:{additionalContext:r}};let a=j(e),s="";try{s=["","[filid] Fractal Structure Rules:",D(_()).map(g=>`- ${g.id}: ${g.description}`).join(`
`),"","Category Classification:",$].join(`
`)}catch{}let i=(a+s).trim();return C(e,i),f(n,e),{continue:!0,hookSpecificOutput:{additionalContext:i}}}var A=[];for await(let t of process.stdin)A.push(t);var B=Buffer.concat(A).toString("utf-8"),h;try{let t=JSON.parse(B);h=await b(t)}catch{h={continue:!0}}process.stdout.write(JSON.stringify(h));
